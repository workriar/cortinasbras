generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usuários do sistema (para autenticação)
model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  name             String?
  passwordHash     String
  role             String    @default("USER") // ADMIN ou USER
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  leads            Lead[]    @relation("UserLeads")
  messagesSent     Message[] @relation("SentMessages")
  messagesReceived Message[] @relation("ReceivedMessages")
}

// Leads do CRM
// Leads do CRM (Mapeado para tabela legada 'leads')
model Lead {
  id           Int           @id @default(autoincrement())
  name         String        @map("nome")
  phone        String        @map("telefone")
  email        String?       @map("email") // Se existir na tabela antiga
  city         String?       @map("cidade_bairro")
  source       String        @default("SITE") @map("origem")
  status       String        @default("NEW") @map("status")
  notes        String?       @map("observacoes")
  
  // Campos específicos do legado que não estavam no model original
  width        Float?        @map("largura_parede")
  height       Float?        @map("altura_parede")
  fabric       String?       @map("tecido")
  installation String?       @map("instalacao")

  createdAt    DateTime      @default(now()) @map("criado_em")
  updatedAt    DateTime      @updatedAt @map("atualizado_em")
  
  ownerId      Int?
  owner        User?         @relation("UserLeads", fields: [ownerId], references: [id])
  interactions Interaction[]
  messages     Message[]

  @@map("leads") // Mapeia para a tabela existente 'leads'
  @@index([ownerId])
  @@index([status])
  @@index([source])
  @@index([createdAt])
}

// Histórico de interações com o lead
model Interaction {
  id        Int      @id @default(autoincrement())
  leadId    Int
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String // CALL, EMAIL, MESSAGE, MEETING
  content   String
  createdAt DateTime @default(now())

  @@index([leadId])
}

// Mensagens de chat interno
model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  leadId     Int?
  lead       Lead?    @relation(fields: [leadId], references: [id])
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([leadId])
}
